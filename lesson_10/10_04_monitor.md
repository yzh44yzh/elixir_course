# Мониторинг процессов

Кроме link есть еще один механизм наблюдения за состоянием процессов -- монитор.

Этот механизм существенно отличается:
- связь односторонняя;
- информация сразу приходит в виде сообщения, а не в виде сигнала;
- получателю не нужно быть системным процессом;
- мониторов может быть несколько, и каждый работает независимо от остальных.

Текущий процесс может установить монитор над другим процессом вызовом [Process.monitor/1](https://hexdocs.pm/elixir/1.12/Process.html#monitor/1) или вызовом [Kernel.spawn_monitor/3](https://hexdocs.pm/elixir/1.12/Kernel.html#spawn_monitor/3), если нужно, чтобы запуск процесса и установка монитора выполнились атомарно.

Запустим несколько процессов под монитором:

```elixir-iex
iex(1)> c "lib/monitor.exs"
[MonitorExample]
iex(2)> alias MonitorExample, as: M
iex(3)> M.run_and_exit(5)
Process id:1 pid:#PID<0.117.0> started
Process id:2 pid:#PID<0.118.0> started
Process id:3 pid:#PID<0.119.0> started
Process id:4 pid:#PID<0.120.0> started
Process id:5 pid:#PID<0.121.0> started
Process id:3 exits
[
  {#PID<0.117.0>, #Reference<0.2596432641.4157341700.33111>},
  {#PID<0.118.0>, #Reference<0.2596432641.4157341700.33112>},
  {#PID<0.119.0>, #Reference<0.2596432641.4157341700.33113>},
  {#PID<0.120.0>, #Reference<0.2596432641.4157341700.33114>},
  {#PID<0.121.0>, #Reference<0.2596432641.4157341700.33115>}
] 
Process id:4 pid:#PID<0.120.0> stopped
Process id:1 pid:#PID<0.117.0> stopped
Process id:5 pid:#PID<0.121.0> stopped
Process id:2 pid:#PID<0.118.0> stopped
```

Вызов spawn_monitor возвращает пару `{pid, ref}`, где ref -- это уникальная ссылка на монитор. Один процесс может установить несколько мониторов, и на один процесс может быть установлено несколько мониторов, поэтому нельзя различить их по pid, нужен отдельный идентификатор.

Мы видим, что 5 процессов стартовали, 1 завершился аварийно, а 4 завершились успешно.

Посмотрим, какие сообщения мы получили:

```elixir-iex
iex(4)> flush()
{:DOWN, #Reference<0.2596432641.4157341700.33113>, :process, #PID<0.119.0>, :some_reason}
{:DOWN, #Reference<0.2596432641.4157341700.33114>, :process, #PID<0.120.0>, :normal}
{:DOWN, #Reference<0.2596432641.4157341700.33111>, :process, #PID<0.117.0>, :normal}
{:DOWN, #Reference<0.2596432641.4157341700.33115>, :process, #PID<0.121.0>, :normal}
{:DOWN, #Reference<0.2596432641.4157341700.33112>, :process, #PID<0.118.0>, :normal}
:ok
```

Если процесс под монитором завершился, то процесс, установивший монитор, получает сообщение `{:DOWN, ref, :process, pid, reason}`. То есть кортеж из 5 элементов, содержащий Pid, ссылку и причину завершения.

Обычно связь между процессами постоянная (хоть ее и можно снять), а монитор устанавливают временно. 

Монитор снимается вызовом [Process.demonitor/2](https://hexdocs.pm/elixir/1.12/Process.html#demonitor/2).

Связи и системные процессы являются низкоуровневыми механизмами, на которых построен OTP фреймворк. Знать про них полезно, но пользоваться напрямую не рекомендуется. Лучше пользоваться абстракциями, которые дает OTP. И это будет темой следущих уроков.

Зато мониторами пользоваться можно и нужно. Они добавляют гибкости там, где средств OTP не хватает.
